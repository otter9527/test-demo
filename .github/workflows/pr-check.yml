name: PR Check

on:
  push:
    branches:
      - "worker/**"
  pull_request:
    types: [opened, synchronize, reopened, edited]
  workflow_dispatch:

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  policy-check:
    name: policy-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: python -m pip install -r .wfkit/requirements.txt
      - name: Validate branch and commit metadata
        run: |
          REF="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          if ! echo "$REF" | grep -Eq '^worker/.+'; then
            echo "Invalid worker branch: $REF" >&2
            exit 1
          fi
          if ! echo "$REF" | grep -Eq '[0-9]+'; then
            echo "Missing task number in branch: $REF" >&2
            exit 1
          fi
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            python .wfkit/scripts/pm/enforce_policy.py \
              --repo "${{ github.repository }}" \
              --pr "${{ github.event.pull_request.number }}"
          else
            MSG=$(git log -1 --pretty=%s)
            if [[ "$MSG" != *"TASK-"* ]]; then
              echo "Commit message must include TASK-* token" >&2
              exit 1
            fi
          fi

  repo-checks:
    name: repo-checks
    runs-on: ubuntu-latest
    needs: [policy-check]
    steps:
      - uses: actions/checkout@v4
      - name: Run repository checks
        run: bash .wfkit/scripts/ci/run_repo_checks.sh
